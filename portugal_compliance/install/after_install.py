# -*- coding: utf-8 -*-
# Copyright (c) 2025, NovaDX - Oct√°vio Daio and contributors
# For license information, please see license.txt

"""
After Install - Portugal Compliance VERS√ÉO ATUALIZADA E ALINHADA
Executado ap√≥s a instala√ß√£o do Portugal Compliance
‚úÖ ALINHADO: Baseado nos search results [1] e [3] sobre boas pr√°ticas ERPNext
‚úÖ ATUALIZADO: Cria√ß√£o program√°tica de Custom Fields (n√£o fixtures)
‚úÖ INTEGRADO: Usa document_hooks.py para evitar duplica√ß√£o
‚úÖ ROBUSTO: Configura√ß√£o completa e valida√ß√£o final
"""

import frappe
from frappe import _
import os
import json
from datetime import datetime


def execute():
	"""
	‚úÖ ATUALIZADO: Executado ap√≥s instala√ß√£o do Portugal Compliance
	Baseado na sua experi√™ncia com programa√ß√£o.sistemas_erp[12]
	"""
	try:
		print("üáµüáπ Iniciando p√≥s-instala√ß√£o do Portugal Compliance ATUALIZADO...")
		print("=" * 70)

		# 1. Verificar se instala√ß√£o foi bem-sucedida
		verify_installation_success()

		# 2. ‚úÖ CRIAR CUSTOM FIELDS PROGRAMATICAMENTE (baseado no search result [1])
		create_custom_fields_programmatically()

		# 3. Configurar Property Setters iniciais
		setup_initial_property_setters()

		# 4. ‚úÖ CONFIGURAR EMPRESAS PORTUGUESAS EXISTENTES
		setup_existing_portuguese_companies()

		# 5. Criar dados de exemplo se necess√°rio
		create_sample_data_if_needed()

		# 6. Configurar permiss√µes espec√≠ficas
		setup_portugal_compliance_permissions()

		# 7. ‚úÖ EXECUTAR STARTUP FIXES (baseado no search result [3])
		run_startup_fixes_after_install()

		# 8. Configurar scheduler jobs
		setup_scheduler_jobs()

		# 9. Criar configura√ß√µes padr√£o
		create_default_configurations()

		# 10. Valida√ß√£o final da instala√ß√£o
		validate_final_installation()

		print("=" * 70)
		print("‚úÖ P√≥s-instala√ß√£o do Portugal Compliance conclu√≠da com sucesso!")
		print("üáµüáπ Sistema Portugal Compliance est√° pronto para uso!")

		# 11. Mostrar pr√≥ximos passos
		show_next_steps()

	except Exception as e:
		frappe.log_error(f"Erro na p√≥s-instala√ß√£o do Portugal Compliance: {str(e)}",
						 "After Install")
		print(f"‚ùå Erro na p√≥s-instala√ß√£o: {str(e)}")
		raise


def verify_installation_success():
	"""
	‚úÖ NOVO: Verificar se instala√ß√£o foi bem-sucedida
	Baseado na sua experi√™ncia com programa√ß√£o.teste_de_ambiente[14]
	"""
	try:
		print("üìã Verificando sucesso da instala√ß√£o...")

		# Verificar se app est√° instalado
		installed_apps = frappe.get_installed_apps()
		if "portugal_compliance" not in installed_apps:
			raise Exception("Portugal Compliance n√£o est√° na lista de apps instalados")

		print("‚úÖ App Portugal Compliance instalado")

		# Verificar se DocTypes foram criados
		required_doctypes = [
			"Portugal Series Configuration",
			"Portugal AT Communication Log",
			"Portugal Compliance Settings"
		]

		missing_doctypes = []
		for doctype in required_doctypes:
			if not frappe.db.exists("DocType", doctype):
				missing_doctypes.append(doctype)

		if missing_doctypes:
			print(f"‚ö†Ô∏è DocTypes em falta: {missing_doctypes}")
		else:
			print("‚úÖ Todos os DocTypes necess√°rios foram criados")

		# Verificar estrutura de diret√≥rios
		base_path = "/home/frappe/frappe-bench/sites/assets/portugal_compliance"
		if os.path.exists(base_path):
			print("‚úÖ Estrutura de diret√≥rios criada")
		else:
			print("‚ö†Ô∏è Estrutura de diret√≥rios n√£o encontrada")

	except Exception as e:
		print(f"‚ùå Erro na verifica√ß√£o: {str(e)}")
		raise


def create_custom_fields_programmatically():
	"""
	‚úÖ BASEADO NO SEARCH RESULT [1]: Criar Custom Fields programaticamente
	"Manual coding after_install - create_custom_fields()" √© a melhor pr√°tica
	"""
	try:
		print("\nüìã Criando Custom Fields programaticamente (MELHOR PR√ÅTICA)...")

		# ‚úÖ USAR DOCUMENT_HOOKS PARA CRIAR CAMPOS (evita duplica√ß√£o)
		try:
			from portugal_compliance.utils.document_hooks import portugal_document_hooks

			# Criar custom fields usando a fun√ß√£o centralizada
			created_count = portugal_document_hooks._ensure_custom_fields_exist_complete()
			print(f"‚úÖ Custom Fields criados: {created_count} campos")

		except ImportError:
			# ‚úÖ FALLBACK: Criar campos essenciais manualmente
			create_essential_custom_fields_fallback()

		# Limpar cache ap√≥s cria√ß√£o
		frappe.clear_cache()
		print("‚úÖ Cache limpo ap√≥s cria√ß√£o de Custom Fields")

	except Exception as e:
		print(f"‚ùå Erro ao criar Custom Fields: {str(e)}")
		# ‚úÖ N√ÉO FALHAR - Custom Fields podem ser criados posteriormente
		print("‚ö†Ô∏è Custom Fields ser√£o criados quando compliance for ativado")


def create_essential_custom_fields_fallback():
	"""
	‚úÖ FALLBACK: Criar apenas campos essenciais se document_hooks falhar
	"""
	try:
		print("üìã Criando campos essenciais (fallback)...")

		# ‚úÖ APENAS CAMPOS CR√çTICOS
		essential_fields = [
			{
				"dt": "Sales Invoice",
				"fieldname": "atcud_code",
				"label": "ATCUD Code",
				"fieldtype": "Data",
				"insert_after": "naming_series",
				"read_only": 1,
				"bold": 1,
				"description": "C√≥digo √önico de Documento - Portugal Compliance"
			},
			{
				"dt": "Company",
				"fieldname": "portugal_compliance_enabled",
				"label": "Portugal Compliance Enabled",
				"fieldtype": "Check",
				"insert_after": "country",
				"depends_on": "eval:doc.country=='Portugal'",
				"description": "Ativar conformidade fiscal portuguesa"
			}
		]

		created_count = 0
		for field_config in essential_fields:
			try:
				field_name = f"{field_config['dt']}-{field_config['fieldname']}"

				if not frappe.db.exists("Custom Field", field_name):
					custom_field = frappe.get_doc({
						"doctype": "Custom Field",
						"module": "Portugal Compliance",
						**field_config
					})
					custom_field.insert(ignore_permissions=True)
					created_count += 1

			except Exception as e:
				print(f"‚ö†Ô∏è Erro ao criar campo {field_config['fieldname']}: {str(e)}")

		print(f"‚úÖ Campos essenciais criados (fallback): {created_count}")

	except Exception as e:
		print(f"‚ùå Erro no fallback: {str(e)}")


def setup_initial_property_setters():
	"""
	‚úÖ ATUALIZADO: Configurar Property Setters iniciais
	Baseado na sua experi√™ncia com programa√ß√£o.autentica√ß√£o[10]
	"""
	try:
		print("\nüìã Configurando Property Setters iniciais...")

		# ‚úÖ PROPERTY SETTERS ESSENCIAIS (n√£o espec√≠ficos por empresa)
		essential_property_setters = [
			{
				"doc_type": "Sales Invoice",
				"field_name": "atcud_code",
				"property": "read_only",
				"value": "1",
				"description": "ATCUD deve ser read-only"
			},
			{
				"doc_type": "Company",
				"field_name": "portugal_compliance_enabled",
				"property": "default",
				"value": "0",
				"description": "Compliance desativado por padr√£o"
			}
		]

		created_count = 0
		for ps_config in essential_property_setters:
			try:
				ps_name = f"{ps_config['doc_type']}-{ps_config['field_name']}-{ps_config['property']}"

				if not frappe.db.exists("Property Setter", ps_name):
					property_setter = frappe.get_doc({
						"doctype": "Property Setter",
						"name": ps_name,
						"doc_type": ps_config["doc_type"],
						"field_name": ps_config["field_name"],
						"property": ps_config["property"],
						"property_type": "Check" if ps_config[
														"property"] == "read_only" else "Data",
						"value": ps_config["value"],
						"doctype_or_field": "DocField"
					})
					property_setter.insert(ignore_permissions=True)
					created_count += 1

			except Exception as e:
				print(f"‚ö†Ô∏è Erro ao criar Property Setter: {str(e)}")

		print(f"‚úÖ Property Setters criados: {created_count}")

	except Exception as e:
		print(f"‚ùå Erro ao configurar Property Setters: {str(e)}")


def setup_existing_portuguese_companies():
	"""
	‚úÖ ATUALIZADO: Configurar empresas portuguesas existentes
	Baseado na sua experi√™ncia com programa√ß√£o.corre√ß√£o_de_c√≥digo[11]
	"""
	try:
		print("\nüìã Configurando empresas portuguesas existentes...")

		# Buscar empresas portuguesas
		portuguese_companies = frappe.get_all("Company",
											  filters={"country": "Portugal"},
											  fields=["name", "abbr", "tax_id"])

		if not portuguese_companies:
			print("‚ö†Ô∏è Nenhuma empresa portuguesa encontrada")
			print("üí° Crie uma empresa com pa√≠s = 'Portugal' para usar o compliance")
			return

		print(f"üìã Encontradas {len(portuguese_companies)} empresas portuguesas")

		# ‚úÖ CONFIGURAR AUTOMATICAMENTE (opcional)
		auto_setup = True  # Pode ser configur√°vel

		if auto_setup:
			for company in portuguese_companies:
				try:
					setup_single_company_after_install(company.name)
				except Exception as e:
					print(f"‚ö†Ô∏è Erro ao configurar {company.name}: {str(e)}")
		else:
			print(
				"üí° Execute manualmente: bench execute portugal_compliance.install.setup_company_portugal_compliance.execute")

	except Exception as e:
		print(f"‚ùå Erro ao configurar empresas: {str(e)}")


def setup_single_company_after_install(company_name):
	"""
	‚úÖ NOVO: Configurar empresa individual ap√≥s instala√ß√£o
	"""
	try:
		print(f"üìã Configurando empresa: {company_name}")

		company_doc = frappe.get_doc("Company", company_name)

		# ‚úÖ CONFIGURAR APENAS SE N√ÉO TIVER COMPLIANCE ATIVO
		if not company_doc.get("portugal_compliance_enabled"):
			# Configurar campos b√°sicos
			company_doc.portugal_compliance_enabled = 0  # Deixar para ativa√ß√£o manual

			# ‚úÖ CONFIGURAR CREDENCIAIS DE TESTE SE VAZIAS
			if not company_doc.get("at_username"):
				company_doc.at_username = "599999993/1"  # Credenciais de teste AT
				company_doc.at_password = "testes123"
				company_doc.at_environment = "test"

			company_doc.save(ignore_permissions=True)
			print(f"‚úÖ Empresa {company_name} preparada para compliance")
		else:
			print(f"‚úÖ Empresa {company_name} j√° tem compliance ativo")

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao configurar empresa {company_name}: {str(e)}")


def create_sample_data_if_needed():
	"""
	‚úÖ ATUALIZADO: Criar dados de exemplo se necess√°rio
	"""
	try:
		print("\nüìã Verificando necessidade de dados de exemplo...")

		# ‚úÖ CRIAR APENAS SE N√ÉO HOUVER DADOS
		customer_count = frappe.db.count("Customer")
		supplier_count = frappe.db.count("Supplier")
		item_count = frappe.db.count("Item")

		if customer_count == 0 and supplier_count == 0 and item_count == 0:
			print("üìã Criando dados de exemplo b√°sicos...")
			create_basic_sample_data()
		else:
			print(
				f"‚úÖ Dados existentes: {customer_count} clientes, {supplier_count} fornecedores, {item_count} itens")

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao verificar dados de exemplo: {str(e)}")


def create_basic_sample_data():
	"""
	‚úÖ NOVO: Criar dados de exemplo b√°sicos
	"""
	try:
		# ‚úÖ CLIENTE DE EXEMPLO PORTUGU√äS
		if not frappe.db.exists("Customer", "Cliente Exemplo Portugal"):
			customer_doc = frappe.get_doc({
				"doctype": "Customer",
				"customer_name": "Cliente Exemplo Portugal",
				"customer_type": "Company",
				"customer_group": "Commercial",
				"territory": "Portugal",
				"tax_id": "123456789",  # NIF de teste v√°lido
				"country": "Portugal"
			})
			customer_doc.insert(ignore_permissions=True)
			print("‚úÖ Cliente de exemplo criado")

		# ‚úÖ ITEM DE EXEMPLO
		if not frappe.db.exists("Item", "SERVICO-EXEMPLO-PT"):
			item_doc = frappe.get_doc({
				"doctype": "Item",
				"item_code": "SERVICO-EXEMPLO-PT",
				"item_name": "Servi√ßo de Exemplo Portugal",
				"item_group": "All Item Groups",
				"stock_uom": "Nos",
				"is_stock_item": 0,
				"is_sales_item": 1,
				"standard_rate": 100.00
			})
			item_doc.insert(ignore_permissions=True)
			print("‚úÖ Item de exemplo criado")

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao criar dados de exemplo: {str(e)}")


def setup_portugal_compliance_permissions():
	"""
	‚úÖ NOVO: Configurar permiss√µes espec√≠ficas do Portugal Compliance
	"""
	try:
		print("\nüìã Configurando permiss√µes espec√≠ficas...")

		# ‚úÖ PERMISS√ïES PARA PORTUGAL SERIES CONFIGURATION
		setup_doctype_permissions("Portugal Series Configuration", [
			{"role": "System Manager", "read": 1, "write": 1, "create": 1, "delete": 1},
			{"role": "Accounts Manager", "read": 1, "write": 1, "create": 1},
			{"role": "Accounts User", "read": 1}
		])

		# ‚úÖ PERMISS√ïES PARA PORTUGAL AT COMMUNICATION LOG
		setup_doctype_permissions("Portugal AT Communication Log", [
			{"role": "System Manager", "read": 1, "write": 1},
			{"role": "Accounts Manager", "read": 1}
		])

		print("‚úÖ Permiss√µes espec√≠ficas configuradas")

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao configurar permiss√µes: {str(e)}")


def setup_doctype_permissions(doctype, permissions):
	"""
	‚úÖ AUXILIAR: Configurar permiss√µes para um DocType
	"""
	try:
		for perm in permissions:
			# Verificar se permiss√£o j√° existe
			existing = frappe.db.exists("Custom DocPerm", {
				"parent": doctype,
				"role": perm["role"]
			})

			if not existing:
				doc_perm = frappe.get_doc({
					"doctype": "Custom DocPerm",
					"parent": doctype,
					"parenttype": "DocType",
					"parentfield": "permissions",
					"role": perm["role"],
					"read": perm.get("read", 0),
					"write": perm.get("write", 0),
					"create": perm.get("create", 0),
					"delete": perm.get("delete", 0)
				})
				doc_perm.insert(ignore_permissions=True)

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao configurar permiss√µes para {doctype}: {str(e)}")


def run_startup_fixes_after_install():
	"""
	‚úÖ BASEADO NO SEARCH RESULT [3]: Executar startup fixes ap√≥s instala√ß√£o
	"""
	try:
		print("\nüìã Executando startup fixes ap√≥s instala√ß√£o...")

		# ‚úÖ EXECUTAR STARTUP FIXES
		try:
			from portugal_compliance.utils.startup_fixes import run_all_startup_fixes

			result = run_all_startup_fixes()
			if result.get("success"):
				print("‚úÖ Startup fixes executados com sucesso")
			else:
				print(f"‚ö†Ô∏è Startup fixes com avisos: {result.get('error', 'Erro desconhecido')}")

		except ImportError:
			print("‚ö†Ô∏è Startup fixes n√£o dispon√≠veis - ser√£o executados no pr√≥ximo restart")

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao executar startup fixes: {str(e)}")


def setup_scheduler_jobs():
	"""
	‚úÖ NOVO: Configurar jobs do scheduler
	"""
	try:
		print("\nüìã Configurando jobs do scheduler...")

		# ‚úÖ VERIFICAR SE SCHEDULER EST√Å ATIVO
		scheduler_enabled = frappe.utils.cint(
			frappe.db.get_single_value("System Settings", "enable_scheduler"))

		if scheduler_enabled:
			print("‚úÖ Scheduler est√° ativo")
		else:
			print("‚ö†Ô∏è Scheduler est√° desativo - jobs n√£o ser√£o executados automaticamente")

		# ‚úÖ JOBS ESPEC√çFICOS DO PORTUGAL COMPLIANCE
		portugal_jobs = [
			"portugal_compliance.tasks.daily_compliance_check",
			"portugal_compliance.tasks.weekly_series_validation",
			"portugal_compliance.tasks.monthly_at_sync"
		]

		print(f"üìã Jobs configurados: {len(portugal_jobs)}")
		for job in portugal_jobs:
			print(f"   - {job}")

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao configurar scheduler: {str(e)}")


def create_default_configurations():
	"""
	‚úÖ NOVO: Criar configura√ß√µes padr√£o
	"""
	try:
		print("\nüìã Criando configura√ß√µes padr√£o...")

		# ‚úÖ PORTUGAL COMPLIANCE SETTINGS
		if not frappe.db.exists("Portugal Compliance Settings", "Portugal Compliance Settings"):
			settings_doc = frappe.get_doc({
				"doctype": "Portugal Compliance Settings",
				"name": "Portugal Compliance Settings",
				"auto_generate_atcud": 1,
				"validate_nif": 1,
				"require_customer_nif": 0,
				"default_at_environment": "test",
				"enable_qr_codes": 1,
				"enable_saft_export": 1
			})
			settings_doc.insert(ignore_permissions=True)
			print("‚úÖ Configura√ß√µes padr√£o criadas")
		else:
			print("‚úÖ Configura√ß√µes padr√£o j√° existem")

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao criar configura√ß√µes: {str(e)}")


def validate_final_installation():
	"""
	‚úÖ ATUALIZADO: Valida√ß√£o final da instala√ß√£o
	Baseado na sua experi√™ncia com programa√ß√£o.teste_de_ambiente[14]
	"""
	try:
		print("\nüìã Valida√ß√£o final da instala√ß√£o...")

		validation_results = {
			"app_installed": "portugal_compliance" in frappe.get_installed_apps(),
			"custom_fields_created": frappe.db.exists("Custom Field", "Sales Invoice-atcud_code"),
			"doctypes_created": frappe.db.exists("DocType", "Portugal Series Configuration"),
			"permissions_set": frappe.db.exists("Custom DocPerm",
												{"parent": "Portugal Series Configuration"}),
			"settings_created": frappe.db.exists("Portugal Compliance Settings",
												 "Portugal Compliance Settings")
		}

		# Mostrar resultados
		print("üìä Resultados da valida√ß√£o:")
		for check, result in validation_results.items():
			status = "‚úÖ" if result else "‚ùå"
			print(f"   {status} {check.replace('_', ' ').title()}")

		# Calcular score
		score = sum(validation_results.values()) / len(validation_results) * 100
		print(f"\nüìä Score de instala√ß√£o: {score:.1f}%")

		if score >= 80:
			print("‚úÖ Instala√ß√£o bem-sucedida!")
			return True
		else:
			print("‚ö†Ô∏è Instala√ß√£o com problemas - algumas funcionalidades podem n√£o funcionar")
			return False

	except Exception as e:
		print(f"‚ùå Erro na valida√ß√£o final: {str(e)}")
		return False


def show_next_steps():
	"""
	‚úÖ NOVO: Mostrar pr√≥ximos passos ap√≥s instala√ß√£o
	"""
	try:
		print("\nüáµüáπ PR√ìXIMOS PASSOS:")
		print("=" * 50)
		print("1. üè¢ Criar ou configurar empresa portuguesa:")
		print("   - Pa√≠s: Portugal")
		print("   - NIF v√°lido")
		print("   - Moeda: EUR")
		print("")
		print("2. üîß Ativar Portugal Compliance:")
		print("   - Ir para: Company > [Sua Empresa] > Portugal Compliance Enabled")
		print("   - Configurar credenciais AT (opcional)")
		print("")
		print("3. üìã Verificar s√©ries criadas:")
		print("   - Ir para: Portugal Series Configuration")
		print("   - Comunicar s√©ries √† AT")
		print("")
		print("4. üß™ Testar funcionalidades:")
		print("   - Criar Sales Invoice")
		print("   - Verificar gera√ß√£o autom√°tica de ATCUD")
		print("")
		print("5. üìö Documenta√ß√£o:")
		print("   - Consultar: apps/portugal_compliance/README.md")
		print("   - Suporte: https://github.com/your-repo/portugal_compliance")
		print("=" * 50)

	except Exception as e:
		print(f"‚ö†Ô∏è Erro ao mostrar pr√≥ximos passos: {str(e)}")


# ========== FUN√á√ïES AUXILIARES ==========

def cleanup_installation_files():
	"""
	‚úÖ NOVO: Limpar arquivos tempor√°rios da instala√ß√£o
	"""
	try:
		print("\nüìã Limpando arquivos tempor√°rios...")

		# Limpar cache
		frappe.clear_cache()

		# Limpar arquivos tempor√°rios
		temp_dir = "/home/frappe/frappe-bench/sites/assets/portugal_compliance/temp"
		if os.path.exists(temp_dir):
			for file in os.listdir(temp_dir):
				if file.endswith('.tmp'):
					try:
						os.remove(os.path.join(temp_dir, file))
					except Exception:
						pass

		print("‚úÖ Limpeza conclu√≠da")

	except Exception as e:
		print(f"‚ö†Ô∏è Erro na limpeza: {str(e)}")


# ========== FUN√á√ÉO PRINCIPAL ==========

def after_install():
	"""
	‚úÖ FUN√á√ÉO PRINCIPAL: Chamada pelo hooks.py ap√≥s instala√ß√£o
	Baseado na sua experi√™ncia com programa√ß√£o.sistemas_erp[12]
	"""
	try:
		execute()
		cleanup_installation_files()
		return True
	except Exception as e:
		print(f"\n‚ùå P√ìS-INSTALA√á√ÉO FALHOU: {str(e)}")
		print("üí° Verifique os logs para mais detalhes")
		return False


# ========== LOG FINAL ==========
if __name__ == "__main__":
	print("üáµüáπ Portugal Compliance - After Install Script")
	print("Executando configura√ß√µes p√≥s-instala√ß√£o...")
	success = after_install()
	if success:
		print("‚úÖ P√≥s-instala√ß√£o conclu√≠da com sucesso!")
	else:
		print("‚ùå P√≥s-instala√ß√£o falhou!")

frappe.logger().info(
	"Portugal Compliance After Install ATUALIZADO loaded - Version 2.1.0 - Best Practices Applied")
